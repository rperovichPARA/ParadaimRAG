<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paradaim RAG Model</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script>
    const marked = {
      parse: function(text) {
        if (!text) return '';
        const tableRegex = /(?:^|\n)((?:\|[^\n]+\|\n)+)/g;
        text = text.replace(tableRegex, (match, tableContent) => {
          const rows = tableContent.trim().split('\n');
          if (rows.length < 2) return match;
          let html = '<table>';
          rows.forEach((row, index) => {
            if (/^[\|\-\:\s]+$/.test(row)) return;
            const cells = row.split('|').filter(cell => cell.trim() !== '');
            const tag = index === 0 ? 'th' : 'td';
            if (index === 0) html += '<thead>';
            if (index === 1) html += '<tbody>';
            html += '<tr>';
            cells.forEach(cell => { html += `<${tag}>${cell.trim()}</${tag}>`; });
            html += '</tr>';
            if (index === 0) html += '</thead>';
          });
          html += '</tbody></table>';
          return '\n' + html + '\n';
        });
        let html = text
          .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
          .replace(/&lt;table&gt;/g, '<table>').replace(/&lt;\/table&gt;/g, '</table>')
          .replace(/&lt;thead&gt;/g, '<thead>').replace(/&lt;\/thead&gt;/g, '</thead>')
          .replace(/&lt;tbody&gt;/g, '<tbody>').replace(/&lt;\/tbody&gt;/g, '</tbody>')
          .replace(/&lt;tr&gt;/g, '<tr>').replace(/&lt;\/tr&gt;/g, '</tr>')
          .replace(/&lt;th&gt;/g, '<th>').replace(/&lt;\/th&gt;/g, '</th>')
          .replace(/&lt;td&gt;/g, '<td>').replace(/&lt;\/td&gt;/g, '</td>')
          .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
          .replace(/`([^`]+)`/g, '<code>$1</code>')
          .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
          .replace(/^### (.+)$/gm, '<h3>$1</h3>')
          .replace(/^## (.+)$/gm, '<h2>$1</h2>')
          .replace(/^# (.+)$/gm, '<h1>$1</h1>')
          .replace(/\*\*\*([^*]+)\*\*\*/g, '<strong><em>$1</em></strong>')
          .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
          .replace(/\*([^*]+)\*/g, '<em>$1</em>')
          .replace(/^---$/gm, '<hr>')
          .replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>')
          .replace(/^\* (.+)$/gm, '<li>$1</li>')
          .replace(/^- (.+)$/gm, '<li>$1</li>')
          .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
          .replace(/\n\n/g, '</p><p>')
          .replace(/\n/g, '<br>');
        html = html.replace(/(<li>.*?<\/li>)(<br>)?(<li>)/g, '$1$3');
        html = html.replace(/(<li>.*?<\/li>)+/g, '<ul>$&</ul>');
        html = '<p>' + html + '</p>';
        html = html.replace(/<p><\/p>/g, '');
        html = html.replace(/<p>(<h[1-4]>)/g, '$1').replace(/(<\/h[1-4]>)<\/p>/g, '$1');
        html = html.replace(/<p>(<pre>)/g, '$1').replace(/(<\/pre>)<\/p>/g, '$1');
        html = html.replace(/<p>(<ul>)/g, '$1').replace(/(<\/ul>)<\/p>/g, '$1');
        html = html.replace(/<p>(<hr>)<\/p>/g, '$1');
        html = html.replace(/<p>(<blockquote>)/g, '$1').replace(/(<\/blockquote>)<\/p>/g, '$1');
        html = html.replace(/<p>(<table>)/g, '$1').replace(/(<\/table>)<\/p>/g, '$1');
        html = html.replace(/<br>(<table>)/g, '$1').replace(/(<\/table>)<br>/g, '$1');
        return html;
      },
      setOptions: function() {}
    };
  </script>
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #111113;
      --bg-tertiary: #18181b;
      --bg-card: #1c1c1f;
      --border: #2a2a2e;
      --border-accent: #3f3f46;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent-primary: #10b981;
      --accent-primary-dim: rgba(16, 185, 129, 0.15);
      --accent-blue: #3b82f6;
      --accent-amber: #f59e0b;
      --accent-purple: #a78bfa;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      font-size: 16px;
    }

    header {
      padding: 1.25rem 2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-secondary);
      flex-shrink: 0;
      z-index: 10;
    }

    .logo { display: flex; align-items: center; gap: 0.75rem; }

    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-blue));
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 0.875rem;
    }

    .logo-text { font-size: 1.25rem; font-weight: 600; letter-spacing: -0.02em; }
    .logo-text span { color: var(--text-muted); font-weight: 400; }

    .config-section { display: flex; align-items: center; gap: 1.25rem; }
    .config-section label { font-size: 0.9375rem; color: var(--text-secondary); }

    .config-section select {
      background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px;
      padding: 0.5rem 0.75rem; color: var(--text-primary); font-family: 'Outfit', sans-serif;
      font-size: 0.9375rem; cursor: pointer; transition: border-color 0.2s; appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 0.75rem center; padding-right: 2rem;
    }
    .config-section select:focus { outline: none; border-color: var(--accent-blue); }
    .config-group { display: flex; align-items: center; gap: 0.5rem; }

    .toggle-group { display: flex; align-items: center; gap: 0.5rem; }
    .toggle-group > label { font-size: 0.9375rem; color: var(--text-secondary); cursor: pointer; user-select: none; }

    .toggle-switch { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; cursor: pointer; inset: 0;
      background: var(--border-accent); border-radius: 20px; transition: background 0.2s ease;
    }
    .toggle-slider::before {
      content: ''; position: absolute; height: 14px; width: 14px; left: 3px; bottom: 3px;
      background: var(--text-primary); border-radius: 50%; transition: transform 0.2s ease;
    }
    .toggle-switch input:checked + .toggle-slider { background: var(--accent-purple); }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(16px); }

    .status-indicator { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9375rem; color: var(--text-muted); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-primary); animation: pulse 2s infinite; }
    .status-dot.error { background: #ef4444; animation: none; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    main {
      flex: 1; display: flex; flex-direction: column;
      padding: 1.5rem 2rem; gap: 1rem; overflow: hidden; min-height: 0;
    }
    .panel-container { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .panel {
      flex: 1; display: flex; flex-direction: column;
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
      overflow: hidden; min-height: 0;
    }
    .panel-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.875rem 1.25rem; border-bottom: 1px solid var(--border); background: var(--bg-tertiary);
    }
    .panel-title { display: flex; align-items: center; gap: 0.5rem; font-weight: 500; font-size: 1rem; }
    .panel-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-primary); }
    .panel-meta { font-size: 0.75rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
    .panel-content { flex: 1; overflow-y: auto; padding: 1rem 1.25rem; min-height: 0; }
    .panel-content::-webkit-scrollbar { width: 6px; }
    .panel-content::-webkit-scrollbar-track { background: transparent; }
    .panel-content::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 3px; }

    .message { margin-bottom: 1rem; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .message-user {
      background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px; padding: 0.875rem 1rem; margin-left: 2rem;
    }
    .message-assistant {
      background: var(--bg-tertiary); border: 1px solid var(--border);
      border-radius: 12px; padding: 1rem;
    }
    .message-content { font-size: 1.0625rem; line-height: 1.75; }
    .message-content h1, .message-content h2 { color: #f59e0b; margin-top: 1rem; margin-bottom: 0.5rem; }
    .message-content h3, .message-content h4 { color: var(--accent-blue); margin-top: 1rem; margin-bottom: 0.5rem; }
    .message-content h1:first-child, .message-content h2:first-child,
    .message-content h3:first-child, .message-content h4:first-child { margin-top: 0; }
    .message-content pre {
      background: var(--bg-primary); border: 1px solid var(--border);
      border-radius: 8px; padding: 1rem; overflow-x: auto; margin: 0.75rem 0;
    }
    .message-content code { font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; }
    .message-content ul { margin: 0.5rem 0; padding-left: 1.5rem; }
    .message-content li { margin: 0.25rem 0; }
    .message-content strong { color: var(--text-primary); }
    .message-content a { color: var(--accent-blue); text-decoration: none; }
    .message-content a:hover { text-decoration: underline; }
    .message-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.9375rem; }
    .message-content th, .message-content td { border: 1px solid var(--border-accent); padding: 0.625rem 0.875rem; text-align: left; }
    .message-content th { background: var(--bg-tertiary); color: var(--accent-blue); font-weight: 600; }
    .message-content td { background: var(--bg-primary); }
    .message-content tr:hover td { background: var(--bg-tertiary); }
    .message-content tbody tr:nth-child(even) td { background: rgba(255, 255, 255, 0.02); }

    /* ‚ïê‚ïê‚ïê Thinking Block ‚ïê‚ïê‚ïê */
    .thinking-block {
      margin-bottom: 1rem;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(167, 139, 250, 0.2);
      background: rgba(167, 139, 250, 0.04);
    }

    .thinking-header {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.75rem 1rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s ease;
    }

    .thinking-header:hover {
      background: rgba(167, 139, 250, 0.08);
    }

    .thinking-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(167, 139, 250, 0.3);
      border-top-color: var(--accent-purple);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }

    .thinking-spinner.done {
      animation: none;
      border-color: var(--accent-purple);
      background: var(--accent-purple);
      position: relative;
    }

    .thinking-spinner.done::after {
      content: '‚úì';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.625rem;
      font-weight: 700;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .thinking-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--accent-purple);
    }

    .thinking-duration {
      margin-left: auto;
      font-size: 0.75rem;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-muted);
    }

    .thinking-chevron {
      font-size: 0.625rem;
      color: var(--text-muted);
      transition: transform 0.2s ease;
      margin-left: 0.25rem;
    }

    .thinking-block.collapsed .thinking-chevron {
      transform: rotate(-90deg);
    }

    .thinking-block.collapsed .thinking-body {
      display: none;
    }

    .thinking-body {
      border-top: 1px solid rgba(167, 139, 250, 0.12);
      padding: 0;
    }

    .thinking-step {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(167, 139, 250, 0.08);
      animation: stepReveal 0.4s ease;
    }

    .thinking-step:last-child {
      border-bottom: none;
    }

    @keyframes stepReveal {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .thinking-step-line {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.875rem;
      line-height: 1.5;
      color: var(--text-secondary);
    }

    .thinking-step-icon {
      flex-shrink: 0;
      margin-top: 0.125rem;
      font-size: 0.8125rem;
    }

    .thinking-step-text {
      flex: 1;
    }

    .thinking-step-text .tool-name {
      color: var(--accent-purple);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8125rem;
      font-weight: 500;
    }

    .thinking-step-text .search-query {
      color: var(--accent-amber);
      font-style: italic;
    }

    .thinking-step-text .found-label {
      color: var(--accent-primary);
    }

    .thinking-retrieved {
      margin-top: 0.5rem;
      margin-left: 1.375rem;
      font-size: 0.75rem;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-muted);
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      max-height: 80px;
      overflow-y: auto;
      line-height: 1.5;
      word-break: break-word;
    }

    .thinking-retrieved::-webkit-scrollbar { width: 4px; }
    .thinking-retrieved::-webkit-scrollbar-track { background: transparent; }
    .thinking-retrieved::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 2px; }

    /* Typing cursor for thinking text */
    .thinking-cursor {
      display: inline-block;
      width: 2px;
      height: 0.875em;
      background: var(--accent-purple);
      margin-left: 2px;
      animation: blink 0.6s infinite;
      vertical-align: text-bottom;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    body.hide-steps .thinking-block { display: none; }

    .loading-indicator { display: flex; align-items: center; gap: 0.5rem; padding: 1rem; color: var(--text-muted); }
    .loading-dots { display: flex; gap: 4px; }
    .loading-dots span { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: bounce 1.4s infinite both; }
    .loading-dots span:nth-child(1) { animation-delay: 0s; }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

    .input-area { padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; flex-shrink: 0; }
    .input-container { display: flex; gap: 0.75rem; align-items: flex-end; }
    .input-wrapper { flex: 1; position: relative; }
    .input-wrapper textarea {
      width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px;
      padding: 0.875rem 1rem; color: var(--text-primary); font-family: 'Outfit', sans-serif;
      font-size: 1.0625rem; resize: none; min-height: 48px; max-height: 150px; transition: border-color 0.2s;
    }
    .input-wrapper textarea:focus { outline: none; border-color: var(--accent-blue); }
    .input-wrapper textarea::placeholder { color: var(--text-muted); }

    .send-button {
      height: 48px; padding: 0 1.5rem;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-blue));
      border: none; border-radius: 12px; color: white; font-family: 'Outfit', sans-serif;
      font-weight: 500; font-size: 1rem; cursor: pointer; transition: opacity 0.2s, transform 0.1s;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .send-button:hover:not(:disabled) { opacity: 0.9; }
    .send-button:active:not(:disabled) { transform: scale(0.98); }
    .send-button:disabled { opacity: 0.5; cursor: not-allowed; }

    .log-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; max-height: 150px; flex-shrink: 0; }
    .log-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.625rem 1rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border);
      cursor: pointer; user-select: none;
    }
    .log-header:hover { background: var(--bg-secondary); }
    .log-title { font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem; }
    .log-toggle { font-size: 0.75rem; color: var(--text-muted); transition: transform 0.2s; }
    .log-panel.collapsed .log-toggle { transform: rotate(-90deg); }
    .log-panel.collapsed .log-content { display: none; }
    .log-content { padding: 0.5rem; max-height: 100px; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.6875rem; }
    .log-entry { padding: 0.25rem 0.5rem; border-radius: 4px; margin-bottom: 2px; display: flex; gap: 0.5rem; }
    .log-entry.info { background: rgba(59, 130, 246, 0.1); color: #60a5fa; }
    .log-entry.success { background: rgba(16, 185, 129, 0.1); color: #34d399; }
    .log-entry.error { background: rgba(239, 68, 68, 0.1); color: #f87171; }
    .log-time { color: var(--text-muted); flex-shrink: 0; }

    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center; padding: 2rem; }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .empty-state-text { font-size: 1.125rem; margin-bottom: 0.5rem; }
    .empty-state-hint { font-size: 0.9375rem; opacity: 0.7; }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-icon">PR</div>
      <div class="logo-text">Paradaim <span>RAG Model</span></div>
    </div>
    <div class="config-section">
      <div class="config-group">
        <label>Workflow:</label>
        <select id="workflow-select">
          <option value="portfolio">Portfolio Director</option>
          <option value="candidate">Candidate Finder</option>
        </select>
      </div>
      <div class="config-group">
        <label>Model:</label>
        <select id="model-select">
          <option value="anthropic">Claude</option>
          <option value="openai">GPT</option>
          <option value="gemini">Gemini</option>
        </select>
      </div>
      <div class="toggle-group">
        <label for="steps-toggle">Thinking</label>
        <label class="toggle-switch">
          <input type="checkbox" id="steps-toggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="status-indicator">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">Ready</span>
      </div>
    </div>
  </header>

  <main>
    <div class="panel-container">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title"><div class="panel-dot"></div><span>AI Response</span></div>
          <div class="panel-meta" id="response-meta">Ready</div>
        </div>
        <div class="panel-content" id="messages">
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-text">Paradaim RAG Model Ready</div>
            <div class="empty-state-hint">Ask about your portfolio or candidates</div>
          </div>
        </div>
      </div>
    </div>
    <div class="input-area">
      <div class="input-container">
        <div class="input-wrapper">
          <textarea id="query-input" placeholder="Ask about your portfolio or candidates..." rows="1"></textarea>
        </div>
        <button class="send-button" id="send-button"><span>Send</span><span>‚Üí</span></button>
      </div>
    </div>
    <div class="log-panel collapsed" id="log-panel">
      <div class="log-header" onclick="toggleLog()">
        <div class="log-title"><span>üìã</span>Execution Log</div>
        <div class="log-toggle">‚ñº</div>
      </div>
      <div class="log-content" id="log-content"></div>
    </div>
  </main>

  <script>
    const WORKFLOWS = {
      portfolio: 'https://rperovich.app.n8n.cloud/webhook/portfolio.director',
      candidate: 'https://rperovich.app.n8n.cloud/webhook-test/equity.rag.compare'
    };

    const workflowSelect = document.getElementById('workflow-select');
    const modelSelect = document.getElementById('model-select');
    const stepsToggle = document.getElementById('steps-toggle');
    const queryInput = document.getElementById('query-input');
    const sendButton = document.getElementById('send-button');
    const messagesEl = document.getElementById('messages');
    const responseMeta = document.getElementById('response-meta');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const logContent = document.getElementById('log-content');
    const logPanel = document.getElementById('log-panel');

    let messages = [];
    let isLoading = false;

    stepsToggle.addEventListener('change', () => {
      document.body.classList.toggle('hide-steps', !stepsToggle.checked);
      addLog('Thinking display: ' + (stepsToggle.checked ? 'ON' : 'OFF'), 'info');
    });

    queryInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });

    function toggleLog() { logPanel.classList.toggle('collapsed'); }

    function addLog(message, type) {
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + (type || 'info');
      entry.innerHTML = '<span class="log-time">' + time + '</span><span>' + message + '</span>';
      logContent.appendChild(entry);
      logContent.scrollTop = logContent.scrollHeight;
    }

    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Friendly tool names
    function friendlyToolName(raw) {
      var map = {
        'Pinecone_Vector_Retrieval': 'Knowledge Base',
        'Financial_Metrics': 'Financial Data',
        'Portfolio_Holdings': 'Portfolio',
        'HTTP_Request_Correlation': 'Correlation Analysis',
        'HTTP Request - Correlation': 'Correlation Analysis'
      };
      return map[raw] || raw.replace(/_/g, ' ');
    }

    // Truncate observation to a short summary
    function summarizeObservation(obs) {
      if (!obs) return '';
      // Try to extract first meaningful sentence
      var clean = obs.replace(/\{"type":"text","text":"?\{?"?\\?"?pageContent\\?"?:?\\?"/g, '').replace(/\\n/g, ' ').replace(/\\"/g, '"');
      if (clean.length > 200) clean = clean.substring(0, 200) + '‚Ä¶';
      return clean;
    }

    function toggleThinking(el) {
      el.closest('.thinking-block').classList.toggle('collapsed');
    }

    // ‚ïê‚ïê‚ïê Animated thinking display ‚ïê‚ïê‚ïê
    async function showThinkingAnimation(steps, thinkingStartTime) {
      if (!steps || steps.length === 0 || !stepsToggle.checked) return;

      var blockId = 'thinking-' + Date.now();

      // Create the thinking block with spinner
      var blockHtml = '<div class="thinking-block" id="' + blockId + '">';
      blockHtml += '<div class="thinking-header" onclick="toggleThinking(this)">';
      blockHtml += '<div class="thinking-spinner" id="' + blockId + '-spinner"></div>';
      blockHtml += '<div class="thinking-label">Thinking‚Ä¶</div>';
      blockHtml += '<div class="thinking-duration" id="' + blockId + '-duration"></div>';
      blockHtml += '<div class="thinking-chevron">‚ñº</div>';
      blockHtml += '</div>';
      blockHtml += '<div class="thinking-body" id="' + blockId + '-body"></div>';
      blockHtml += '</div>';

      messagesEl.insertAdjacentHTML('beforeend', blockHtml);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      var body = document.getElementById(blockId + '-body');

      // Animate each step appearing
      for (var i = 0; i < steps.length; i++) {
        var step = steps[i];
        var friendly = friendlyToolName(step.tool);

        // Step 1: Show "Searching <tool>..."
        var stepEl = document.createElement('div');
        stepEl.className = 'thinking-step';
        stepEl.innerHTML = '<div class="thinking-step-line">' +
          '<span class="thinking-step-icon">üîç</span>' +
          '<span class="thinking-step-text">Searching <span class="tool-name">' + escapeHtml(friendly) + '</span> for <span class="search-query">"' + escapeHtml(step.query) + '"</span><span class="thinking-cursor"></span></span>' +
          '</div>';
        body.appendChild(stepEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        await new Promise(function(r) { setTimeout(r, 600); });

        // Step 2: Replace with "Found relevant content" + retrieved preview
        var summary = summarizeObservation(step.observation);
        var resultHtml = '<div class="thinking-step-line">' +
          '<span class="thinking-step-icon">‚úì</span>' +
          '<span class="thinking-step-text">Searched <span class="tool-name">' + escapeHtml(friendly) + '</span> for <span class="search-query">"' + escapeHtml(step.query) + '"</span> ‚Äî <span class="found-label">found relevant content</span></span>' +
          '</div>';
        if (summary) {
          resultHtml += '<div class="thinking-retrieved">' + escapeHtml(summary) + '</div>';
        }
        stepEl.innerHTML = resultHtml;
        messagesEl.scrollTop = messagesEl.scrollHeight;

        if (i < steps.length - 1) {
          await new Promise(function(r) { setTimeout(r, 300); });
        }
      }

      // Finalize: swap spinner for checkmark, update label and duration
      var spinner = document.getElementById(blockId + '-spinner');
      if (spinner) spinner.className = 'thinking-spinner done';

      var labelEl = document.getElementById(blockId).querySelector('.thinking-label');
      if (labelEl) labelEl.textContent = 'Thought for ' + ((Date.now() - thinkingStartTime) / 1000).toFixed(1) + 's';

      var durationEl = document.getElementById(blockId + '-duration');
      if (durationEl) durationEl.textContent = steps.length + ' tool call' + (steps.length > 1 ? 's' : '');

      // Store in messages for re-render
      messages.push({ role: 'thinking', steps: steps, blockId: blockId });
    }

    // Re-render stored thinking blocks (for scroll-back)
    function renderStoredThinking(msg) {
      var steps = msg.steps;
      var html = '<div class="thinking-block collapsed">';
      html += '<div class="thinking-header" onclick="toggleThinking(this)">';
      html += '<div class="thinking-spinner done"></div>';
      html += '<div class="thinking-label">Thought ¬∑ ' + steps.length + ' tool call' + (steps.length > 1 ? 's' : '') + '</div>';
      html += '<div class="thinking-chevron">‚ñº</div>';
      html += '</div>';
      html += '<div class="thinking-body">';
      steps.forEach(function(step) {
        var friendly = friendlyToolName(step.tool);
        var summary = summarizeObservation(step.observation);
        html += '<div class="thinking-step">';
        html += '<div class="thinking-step-line"><span class="thinking-step-icon">‚úì</span>';
        html += '<span class="thinking-step-text">Searched <span class="tool-name">' + escapeHtml(friendly) + '</span> for <span class="search-query">"' + escapeHtml(step.query) + '"</span> ‚Äî <span class="found-label">found relevant content</span></span></div>';
        if (summary) html += '<div class="thinking-retrieved">' + escapeHtml(summary) + '</div>';
        html += '</div>';
      });
      html += '</div></div>';
      return html;
    }

    function renderMessages() {
      if (messages.length === 0) {
        messagesEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div class="empty-state-text">Paradaim RAG Model Ready</div><div class="empty-state-hint">Ask about your portfolio or candidates</div></div>';
        return;
      }
      messagesEl.innerHTML = messages.map(function(msg) {
        if (msg.role === 'user') {
          return '<div class="message message-user"><div class="message-content">' + escapeHtml(msg.content) + '</div></div>';
        } else if (msg.role === 'thinking') {
          return renderStoredThinking(msg);
        } else {
          return '<div class="message message-assistant"><div class="message-content">' + marked.parse(msg.content) + '</div></div>';
        }
      }).join('');
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showLoading() {
      messagesEl.insertAdjacentHTML('beforeend',
        '<div class="loading-indicator" id="loading"><div class="loading-dots"><span></span><span></span><span></span></div><span>Analyzing...</span></div>');
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function hideLoading() {
      var el = document.getElementById('loading');
      if (el) el.remove();
    }

    async function addTypingMessage(content) {
      var speed = 5;
      messages.push({ role: 'assistant', content: '' });
      var msgIndex = messages.length - 1;

      // Append a new assistant bubble (don't re-render everything)
      var msgDiv = document.createElement('div');
      msgDiv.className = 'message message-assistant';
      msgDiv.innerHTML = '<div class="message-content"></div>';
      messagesEl.appendChild(msgDiv);
      var contentEl = msgDiv.querySelector('.message-content');

      for (var i = 0; i <= content.length; i++) {
        messages[msgIndex].content = content.substring(0, i);
        contentEl.innerHTML = marked.parse(messages[msgIndex].content);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        if (speed > 0 && i < content.length) {
          await new Promise(function(r) { setTimeout(r, speed); });
        }
      }
    }

    async function sendQuery() {
      var query = queryInput.value.trim();
      if (!query || isLoading) return;

      var webhookUrl = WORKFLOWS[workflowSelect.value];
      isLoading = true;
      sendButton.disabled = true;
      queryInput.value = '';
      queryInput.style.height = 'auto';

      messages.push({ role: 'user', content: query });
      renderMessages();
      showLoading();

      var workflowName = workflowSelect.value === 'portfolio' ? 'Portfolio Director' : 'Candidate Finder';
      addLog('Query: "' + query.substring(0, 50) + (query.length > 50 ? '...' : '') + '" via ' + workflowName, 'info');

      var startTime = Date.now();

      try {
        var history = messages.filter(function(m) { return m.role !== 'thinking'; }).slice(-10).map(function(m) {
          return { role: m.role === 'user' ? 'user' : 'assistant', content: m.content };
        });

        var response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: query, chatInput: query, model: modelSelect.value, history: history })
        });

        if (!response.ok) throw new Error('HTTP ' + response.status + ': ' + response.statusText);

        var data = await response.json();
        var elapsed = Date.now() - startTime;

        statusDot.classList.remove('error');
        statusText.textContent = 'Connected';
        hideLoading();

        // Animate thinking steps
        var steps = data.steps || [];
        if (steps.length > 0) {
          await showThinkingAnimation(steps, startTime);
          addLog('Tools: ' + steps.map(function(s) { return s.tool; }).join(', '), 'info');
        }

        var responseContent = data.response || data.rag || data.output || 'No response received';
        await addTypingMessage(responseContent);

        var modelName = modelSelect.value === 'anthropic' ? 'Claude' : modelSelect.value === 'openai' ? 'GPT' : 'Gemini';
        var responseTime = data.responseTime || elapsed;
        responseMeta.textContent = modelName + ' ¬∑ ' + responseTime + 'ms';

        addLog('Response: ' + responseTime + 'ms | ' + modelName + ' (Execution: ' + (data.executionId || 'N/A') + ')', 'success');

      } catch (error) {
        hideLoading();
        statusDot.classList.add('error');
        statusText.textContent = 'Error';
        messages.push({ role: 'assistant', content: 'Error: ' + error.message });
        renderMessages();
        addLog('Request failed: ' + error.message, 'error');
      }

      isLoading = false;
      sendButton.disabled = false;
      queryInput.focus();
    }

    sendButton.addEventListener('click', sendQuery);
    queryInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendQuery(); }
    });

    workflowSelect.addEventListener('change', function() {
      addLog('Workflow: ' + (workflowSelect.value === 'portfolio' ? 'Portfolio Director' : 'Candidate Finder'), 'info');
    });
    modelSelect.addEventListener('change', function() {
      var n = modelSelect.value === 'anthropic' ? 'Claude' : modelSelect.value === 'openai' ? 'GPT' : 'Gemini';
      addLog('Model: ' + n, 'info');
    });

    addLog('Dashboard ready', 'success');
  </script>
</body>
</html>
